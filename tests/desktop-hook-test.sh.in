#!/bin/bash -e

TEST_DIR=@CMAKE_CURRENT_BINARY_DIR@
SRC_DIR=@CMAKE_CURRENT_SOURCE_DIR@

CACHE_DIR=${TEST_DIR}/desktop-hook-test-click-dir
CLICK_DIR=${CACHE_DIR}/ubuntu-app-launch/desktop/

DATA_DIR=${TEST_DIR}/desktop-hook-test-apps-dir
APPS_DIR=${DATA_DIR}/applications/

# Remove the old directories
rm -rf ${CACHE_DIR}
rm -rf ${DATA_DIR}

# Copy our source applications
mkdir -p ${CLICK_DIR}
cp ${SRC_DIR}/link-farm/* ${CLICK_DIR}

# Setup the environment
export XDG_CACHE_HOME=${CACHE_DIR}
export XDG_DATA_HOME=${DATA_DIR}
export TEST_CLICK_DB=@CMAKE_CURRENT_SOURCE_DIR@/click-db-dir
export TEST_CLICK_USER=test-user

# Run the tool
@CMAKE_BINARY_DIR@/desktop-hook

# Check that the files exist

if [ ! -e ${APPS_DIR}/com.test.good_application_1.2.3.desktop ] ; then
	echo "Desktop file not created for: com.test.good_application_1.2.3"
	exit 1
fi

if [ ! -e ${APPS_DIR}/com.test.multiple_first_1.2.3.desktop ] ; then
	echo "Desktop file not created for: com.test.multiple_first_1.2.3"
	exit 1
fi

# Verify we're adding containment to them

grep "^Exec=aa-exec-click -p com.test.good_application_1.2.3 --" ${APPS_DIR}/com.test.good_application_1.2.3.desktop > /dev/null
grep "^Exec=aa-exec-click -p com.test.multiple_first_1.2.3 --" ${APPS_DIR}/com.test.multiple_first_1.2.3.desktop > /dev/null

# Make sure they have the AppID (people started using it) :-/

grep "^X-Ubuntu-Application-ID=com.test.good_application_1.2.3" ${APPS_DIR}/com.test.good_application_1.2.3.desktop > /dev/null
grep "^X-Ubuntu-Application-ID=com.test.multiple_first_1.2.3" ${APPS_DIR}/com.test.multiple_first_1.2.3.desktop > /dev/null

# Remove a source file and make sure it goes

rm -f ${CLICK_DIR}/com.test.multiple_first_1.2.3.desktop
@CMAKE_BINARY_DIR@/desktop-hook
if [ -e ${APPS_DIR}/com.test.multiple_first_1.2.3.desktop ] ; then
	echo "Not cleaning up deleted files"
	exit 1
fi

# Build a new source directory

CACHE2_DIR=${TEST_DIR}/desktop-hook-test-click-dir2
CLICK2_DIR=${CACHE2_DIR}/ubuntu-app-launch/desktop/
rm -rf ${CACHE2_DIR}
mkdir -p ${CLICK2_DIR}
cp ${SRC_DIR}/link-farm/* ${CLICK2_DIR}

# Point to the new directory and run the tool
export XDG_CACHE_HOME=${CACHE2_DIR}
@CMAKE_BINARY_DIR@/desktop-hook

# Verify that we now have two files again
if [ ! -e ${APPS_DIR}/com.test.good_application_1.2.3.desktop ] ; then
	echo "Desktop file not created for: com.test.good_application_1.2.3"
	exit 1
fi
if [ ! -e ${APPS_DIR}/com.test.multiple_first_1.2.3.desktop ] ; then
	echo "Desktop file not created for: com.test.multiple_first_1.2.3"
	exit 1
fi

# Now switch back and ensure it goes away
export XDG_CACHE_HOME=${CACHE_DIR}
@CMAKE_BINARY_DIR@/desktop-hook
if [ -e ${APPS_DIR}/com.test.multiple_first_1.2.3.desktop ] ; then
	echo "Not cleaning up deleted files"
	exit 1
fi
